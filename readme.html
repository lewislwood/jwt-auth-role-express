<h1>JWT-Auth Express API</h1>

<p>This project is the begginnings of an API Authentification Token based system.</p>

<p>This API provides no sanitization of input, vo input validation of any sorts.  For example: I am inputting a user name for email for my testing purposes.  It does everything in memory, so restart server and tests will start over. (No users/tokens issued/registered).</p>

<p>Only requirement is NodeJs. There are 3 scripts to launch various options.</p>

<ul>
<li>npm run watch   // Will run compiler for Typescript changes</li>
<li>npm run dev  // runs the api server on port 3000</li>
<li>npm run test  // runs the javascript file runs a bunch of tests and generate a tests.log file</li>
</ul>

<p>Each runs in a different terminal.</p>

<h2>Typical Develop Cycle</h2>

<p>I like to run the Typescript watch in one terminal. Nothing I hate more than wondering why my code is still not working.  The watch makes sure code is recompiled immediately. That leaves it up to me to restart the server to incorporate the latest code.</p>

<ol>
<li>Terminal 1: npm run watch</li>
<li>f5 for debug server launch file</li>
<li>terminal 2 : npm run test</li>
<li><p>Open file tests.log and see results of test run.</p>

<p>Hint: You can clear the tests.log between runs.  Make sure to save changes. It will automatically repopulate the next test results When you run it. So leave it open. I like code edit window 3 ctrl+3.</p>

<p>Now I can see terminal window for test errors. and Java console for server errors. ctrl+shift+y.</p></li>
</ol>

<hr />

<h2>Setup Instal this repo</h2>

<p>This repo has numerous branches and you will want to look at them in order. This way you can learn from them. If you are already confident and just want a starter template, then use the main and clone it only.</p>

<ol>
<li>Clone Repository "git clone [https://github.com/lewislwood/jwt-auth-role-express]"</li>
<li>In the folder type "git fetch --all" // This will download all branches.</li>
<li>Type "npm install"  // Installs depencies (dotenv,bcryptjs,express,typescript,winston</li>
<li>rename .env-sample to .env  // you really should generate your own unique token key <em>see below</em>) I know I am not using this key, but others may</li>
<li>Now checkout the branch you want to play with. "git checkout auth" // The first branch</li>
</ol>

<p>Braches are [main, auth, role, final]  </p>

<hr />

<h2>Branches</h2>

<p>Three other branches besides the "main branch" which is the final branch all cleaned up.</p>

<h3>Auth Branch</h3>

<p>Auth branch is the basic authentification branch. The beginnings of an authentification system.</p>

<p>You can switch to it this way:</p>

<p>~~~~ git checkout auth</p>

<p>Startup script is index.ts, but the app.ts is where the code is.  App.ts I have left the route, controller code there for your ease of reviewing. Normally controller code is placed elsewhere, under a sub-folder controllers. I will do this in the final branch.</p>

<p>Routes /register &amp; /login both issue tokens. This is a service and will be moved as well later. Note the payload I defined is User id &amp; email, later I will put the roles here as well in the next branch. You are free to put any info in the payload as you wnt, not too large though. This way the info is with the request and requires no lookup (especially in real world you will have a database query).  This is an api so typically you would set the token for a short time (2 hours).  Now in a more complicated system you would use refresh tokens as well and perhaps oauth providers like google, facebook. That is beyond this example.</p>

<p>Auth.ts is where the verifyToken code is stored and does it's magic.  If the token is valid it is decoded and placed on the request object as a user object.  Which is the payload defined earlier.  Currently to illustrate I put the auth on the 2 routes that require authentification. Do not worry the auth only gets called once, on the route that matches. If verification fails res.send(.... will end the processing and return the error to the client.  If it passes it is passed on the next chain in the route. 
  In the role I will move the auth to a app.use( auth  // just above the authenticatification routes. Since role based authentification will need the payload to hold the role.</p>

<p>Test.js has 3 primary test functions. RegisterLogin,tokenAuth, &amp; TokenExpire. Feel free to comment any test y9ou do not want to perform.  Review the output in the tess.log file. This demonstrates the number of tests that are needed to write a good api. This is usually performed by api clients like Postman and others. They use defined collections of tests/requests.</p>

<hr />

<h2>Generating a Random Token Key</h2>

<p>I provide two ways to generate a random token key</p>

<h3>Generate via OpenSSL</h3>

<p>This requires OpenSSL installed, which is the case for most Linux installations.</p>

<p>~~~~~ $ openssl rand -base64 32</p>

<p>Copy the output as your token key.</p>

<h3>Token via Node</h3>

<p>This one requires Nodejs, which the project requires as well. Simply go to your terminal and enter the nodejs interactive session by entering:</p>

<p>~~~~~ node</p>

<p>Now in the node_ prompmpt enter:</p>

<p>~~~~ require("crypto").randomBytes(64).toString("hex") //token outputed</p>

<p>This will output a 64 byte hex code token.</p>

<hr />
